# 第三章 MVC 模式，项目和约定

在深入了解ASP.NET Core MVC的细节之前，我想确保您熟悉MVC设计模式背后的思路以及将其转换为ASP.NET Core MVC项目的方式。
您可能已经了解本章中讨论的一些想法和约定，特别是如果您已经完成了高级ASP.NET或C#开发。 如果没有，我鼓励你仔细阅读 - 深入地理解隐藏在MVC背后的东西可以帮助你在通读本书时更好地与MVC框架的功能联系起来。

## MVC的历史
模型视图控制器模式起源于20世纪70年代后期，来自施乐PARC的Smalltalk项目，它被设想为组织一些早期的GUI应用程序。 原始MVC模式的一些细节与Smalltalk特定的概念（如屏幕和工具）有关，但更广泛的概念仍然适用于应用程序，并且它们特别适合于Web应用程序。

## 理解MVC模式

在高层次上，MVC模式意味着MVC应用程序将被分成至少三个。

* 模型，其中包含或表示用户使用的数据
* 视图，用于将模型的某些部分呈现为用户界面
* 控制器处理传入请求，对模型执行操作，并选择要呈现给用户的视图
每一块MVC架构都有明确的界定和独立的，这被称为分离问题。 在模型中操纵数据的逻辑只包含在模型中; 显示数据的逻辑只在视图中，处理用户请求和输入的代码只包含在控制器中。 每个部分之间有明确的划分，您的应用程序将更容易维护并延长其使用寿命，无论它最终变得多么复杂。

#### 理解模型
模型 - MVC中的M - 包含用户使用的数据。有两种广泛的模型：视图模型，它们代表从控制器传递到视图的数据。领域模型：业务领域中的数据以及操作，转换和规则，用于创建、存储并操纵该数据，统称为模型逻辑。
模型是您的应用程序工作的环境的定义。例如，在银行应用程序中，该模型表示应用程序支持的银行中的所有内容，如帐户、总帐和客户的信用限额以及可用于存入资金并从账户中提款等类似模型中数据的操作。该模型还负责保存数据的整体状态和一致性 - 确保所有事务被添加到客户不会比银行有权获得更多的钱或者比银行更多的钱提取更多的钱。
对于MVC模式中的每个组件，我将描述它应该包括哪些东西和不应该包括哪些东西。

使用MVC模式构建的应用程序中的模型应该：

* 包含域数据
* 包含用于创建，管理和修改域数据的逻辑
* 提供一个清晰的API，以暴露模型数据和操作

模型不应该：

* 揭示如何获取或管理模型数据的细节（换句话说，细节的数据存储机制不应该暴露给控制器和视图）
* 包含根据用户交互转换模型的逻辑（因为这是控制器的工作）
* 包含向用户显示数据的逻辑（应由视图负责）
确保模型与控制器和视图隔离的好处是可以让测试变得更容易（我在第7章中描述单元测试），并且可以让整个应用程序更简单。

提示:许多刚接触MVC的开发人员对在数据模型中包含逻辑感到困惑，认为MVC模式的目标是将数据与逻辑分离。 这是一个误会：MVC模式的目标是将应用程序分成三个功能区域，每个功能区域可以包含逻辑和数据。 目标不是消除模型中的逻辑。 而是确保模型只包含用于创建和管理模型数据的逻辑。

#### 理解控制器
控制器是MVC模式中的结缔组织，用作数据模型和视图之间的通道。 控制器定义提供在数据模型上运行的业务逻辑的动作，并向用户提供查看显示的数据。

使用MVC模式构建的控制器应该是：
* 根据用户交互包含更新模型所需的操作

控制器不应该：
* 包含管理数据外观的逻辑（即视图的工作）
* 包含管理数据持久性的逻辑（即模型的工作）

#### 理解视图
视图包含向用户显示数据或从用户捕获数据所需的逻辑，以便可以通过控制器操作进行处理。 

视图应该：
* 包含向用户呈现数据所需的逻辑和标记

视图不应该：
* 包含复杂的逻辑（放在控制器中更好）
* 包含创建，存储或操纵域模型的逻辑
视图可以包含逻辑，但应该简单，且须谨慎使用。除了最简单的方法调用或表达式，在视图中放置任何东西，会使整个应用程序更难测试和维护。

## MVC的在ASP.NET上的实现
顾名思义，ASP.NET Core MVC将抽象MVC模式应用于ASP.NET和C＃开发的世界。 在ASP.NET Core MVC中，控制器是C#类，通常派生自Microsoft AspNetCore.Mvc.Controller类。 从Controller派生的类中的每个公共方法都是与URL相关联的行动方法。 当请求发送到与行动方法相关联的URL时，执行该行动方法中的语句，以便对域模型执行某些操作，然后选择要向客户端显示的视图。
图3-1显示了控制器，模型和视图之间的交互。

![控制器，模型和视图之间的交互](/imgs/fig.3.1.png)

图3-1 控制器，模型和视图之间的交互。

ASP.NET Core MVC使用一种称为Razor的视图引擎，它是负责处理视图的组件，以便为浏览器生成响应。 Razor视图是包含C＃逻辑的HTML模板，用于处理模型数据以生成响应模型更改的动态内容。 我将在第5章中解释Razor的作用。
ASP.NET Core MVC不会对领域模型的实现施加任何限制。 您可以使用常规C#对象创建模型，并使用任何数据库，对象关联映射框架或.NET支持的其他数据工具来实现持久性。

## MVC与其他模式的对比

当然，MVC不是唯一的软件架构模式。 还有很多其他的，其中有些是或至少已经非常受欢迎。 您可以通过查看替代方案了解有关MVC的许多内容。 在以下部分中，我简要介绍了构建应用程序的不同方法，并将其与MVC进行对比。 一些模式与MVC有些许的差异，而另一些则完全不一样。

我不是说MVC是最完美的模式。 我支持采取最佳方法解决手头问题。 有些情况下，某些模式与MVC一样好或可能更好。 我鼓励您在选择模式时做出明智的选择。 您正在阅读本书的事实表明，您已经决定使用MVC模式了，但是保持开阔的视野对你总是有好处的。

#### 理解Smart UI 模式

最常见的设计模式之一就是智能用户界面（smart UI）。大多数程序员在职业生涯中的某个时候创建​​了一个智能UI应用程序 - 我当然有。如果您已经使用Windows窗体或ASP.NET Web窗体，那么您也这样做了。
要构建一个智能UI应用程序，开发人员通常将一组组件或控件拖到设计表面或画布上构建用户界面。控件通过发出按钮按压，击键，鼠标移动等事件来报告与用户的交互。开发人员添加了一系列事件处理程序来响应这些事件的代码;这些是在发出特定组件上的特定事件时调用的小块代码。这将创建一个单片应用程序，如图3-2所示。处理用户界面和业务的代码都是混合在一起的，没有任何分离的问题。定义数据输入的可接受值并且查询数据或修改用户帐户的代码最终以小部分结束，并按预期的顺序耦合在一起。

![Smart UI 模式](/imgs/fig.3-2.png)

图3-2 Smart UI 模式

智能UI是简单项目的理想选择，因为您可以快速获得一些好的结果（相比之下，在MVC开发中，正如你将在第8章中看到的那样，需要在交付结果前进行大量的初始投资）。智能UI也适用于用户界面原型。这些设计UI工具可以真的很好，如果你和客户坐在一起，想要捕捉到外观和流程的要求，一个智能的UI工具可以快速有效地生成和验证不同的想法。Smart UI最大的缺点是难以维护和扩展。混合领域模型和业务逻辑代码与用户界面代码导致代码冗余，其中相同的业务逻辑被复制和粘贴以支持新添加的组件。找到所有重复的部分并修复可能很困难。添加新功能而不会破坏现有的功能几乎是不可能的。测试智能UI应用程序也可能很困难，唯一的方法是模拟用户交互，那非常不理想，提供全面测试覆盖更是不太可能。
在MVC的世界中，Smart UI通常被称为反模式：应该不惜一切代价避免。这种反感来自，人们花了一半的职业生涯尝试开发和维护智能UI应用程序，后来结果却一团糟，后来人们才发现MVC是一个更好的方案。
我的意思是说，拒绝智能UI模式是错误的。Smart UI模式并非都那么糟糕，它有好的方面。Smart UI应用程序快速且容易开发。组件和设计工具生产者已经为开发做出了很大的努力。开发体验是愉快的，甚至最无经验的程序员可以在短短几个小时内产生一些专业而又合理的东西。

Smart UI应用程序的最大弱点 - 可维护性 - 在小型开发工作中不会出现。 如果您正在为小客户制作一个简单的工具，Smart UI应用程序可以是一个很好的解决方案。 MVC应用程序太复杂太烦人。

#### 理解模型-视图体系结构
在Smart UI应用程序中容易出现维护问题的部分是业务逻辑，它分散在整个应用程序中，使得修改或添加功能十分麻烦。 模型-视图架构改进了好多，它将业务逻辑转化为单独的域模型。 这样数据、进程和规则都集中在应用程序的一部分中，如图3-3所示。

![模型-视图模式](/imgs/fig.3-3.png)
图 3-3 模型-视图模式

模型视图架构可以是单片智能UI模式的改进 - 例如，更容易维护，但是会出现两个问题。 首先是因为UI和领域模型是紧密结合的，所以在这两者之间进行单元测试是很困难的。 第二个问题来自实践，而不是模式的定义。 该模型通常包含大量的数据访问代码 -虽然不总是这样，但通常是- 这意味着数据模型不仅包含业务数据，操作和规则。

#### 理解经典的三层架构

为了解决模型视图架构的问题，三层模式将持久性代码与域模型分离，并将其放置在称为数据访问层（DAL）的新组件中。 如图3-4所示。

![三层架构](/imgs/fig.3-4.png)
图 3-4 三层架构

三层架构是业务应用程序中使用最广泛的模式。 它对UI的实现没有任何限制，并且提供了很好的分离关注点，而不会太复杂。 而且可以创建DAL，使单元测试相对容易。 您可以看到经典三层应用程序和MVC模式之间的明显相似之处。 不同的是，当UI层直接耦合到点击事件GUI框架（如Windows窗体或ASP.NET Web窗体）时，几乎不可能执行自动化单元测试。 而且因为三层应用程序的UI部分可能很复杂，所以有很多代码不能被严格的测试。